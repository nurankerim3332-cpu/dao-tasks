<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#0a0c10">
<title>–ó–∞–¥–∞—á–∏ ‚Äî DAO Group</title>
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600&family=Unbounded:wght@700;900&family=Mulish:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-msal-browser/3.10.0/msal-browser.min.js"></script>
<style>
:root {
  --bg: #0a0c10;
  --surface: #13161f;
  --surface2: #1a1e2a;
  --surface3: #1f2436;
  --border: #252b3b;
  --border2: #2e3650;
  --accent: #4f8ef7;
  --accent-soft: rgba(79,142,247,0.12);
  --green: #2dd4a0;
  --green-soft: rgba(45,212,160,0.12);
  --yellow: #f5c842;
  --yellow-soft: rgba(245,200,66,0.12);
  --red: #f75e5e;
  --red-soft: rgba(247,94,94,0.12);
  --text: #e2e8f5;
  --text2: #a0aec0;
  --muted: #5a6480;
  --mono: 'JetBrains Mono', monospace;
  --head: 'Unbounded', sans-serif;
  --body: 'Mulish', sans-serif;
}

* { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
html, body { height: 100%; overflow: hidden; }
body {
  font-family: var(--body);
  background: var(--bg);
  color: var(--text);
  display: flex;
  flex-direction: column;
  max-width: 480px;
  margin: 0 auto;
  position: relative;
}

/* ‚îÄ‚îÄ LOGIN SCREEN ‚îÄ‚îÄ */
#loginScreen {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 40px 32px;
  text-align: center;
  background: radial-gradient(ellipse at 50% 30%, rgba(79,142,247,0.08) 0%, transparent 70%);
}
.login-logo {
  width: 72px; height: 72px;
  background: linear-gradient(135deg, var(--accent), #7c5ef7);
  border-radius: 20px;
  display: flex; align-items: center; justify-content: center;
  font-size: 32px;
  margin-bottom: 28px;
  box-shadow: 0 8px 32px rgba(79,142,247,0.25);
}
.login-title {
  font-family: var(--head);
  font-size: 22px;
  font-weight: 900;
  margin-bottom: 8px;
  line-height: 1.2;
}
.login-title span { color: var(--accent); }
.login-sub { font-size: 13px; color: var(--text2); line-height: 1.6; margin-bottom: 40px; }
.btn-login {
  background: var(--accent);
  color: white;
  border: none;
  border-radius: 14px;
  padding: 16px 32px;
  font-family: var(--body);
  font-size: 15px;
  font-weight: 700;
  cursor: pointer;
  width: 100%;
  display: flex; align-items: center; justify-content: center; gap: 10px;
  transition: all 0.2s;
  box-shadow: 0 4px 20px rgba(79,142,247,0.3);
}
.btn-login:hover { transform: translateY(-1px); box-shadow: 0 6px 28px rgba(79,142,247,0.4); }
.btn-login:active { transform: translateY(0); }

/* ‚îÄ‚îÄ APP SCREEN ‚îÄ‚îÄ */
#appScreen { flex: 1; display: none; flex-direction: column; overflow: hidden; }

/* Header */
.app-header {
  padding: 16px 16px 0;
  flex-shrink: 0;
}
.header-top {
  display: flex; align-items: center; justify-content: space-between;
  margin-bottom: 14px;
}
.header-title {
  font-family: var(--head);
  font-size: 18px;
  font-weight: 900;
}
.header-title span { color: var(--accent); }
.header-actions { display: flex; gap: 8px; }
.icon-btn {
  width: 38px; height: 38px;
  background: var(--surface2);
  border: 1px solid var(--border);
  border-radius: 10px;
  display: flex; align-items: center; justify-content: center;
  cursor: pointer; font-size: 16px;
  transition: all 0.15s;
}
.icon-btn:active { background: var(--surface3); }

/* Search */
.search-wrap {
  position: relative;
  margin-bottom: 12px;
}
.search-icon {
  position: absolute; left: 12px; top: 50%; transform: translateY(-50%);
  color: var(--muted); font-size: 14px; pointer-events: none;
}
#searchInput {
  width: 100%;
  background: var(--surface2);
  border: 1px solid var(--border);
  border-radius: 12px;
  padding: 11px 12px 11px 36px;
  color: var(--text);
  font-family: var(--body);
  font-size: 14px;
  outline: none;
  transition: border-color 0.2s;
}
#searchInput:focus { border-color: var(--accent); }
#searchInput::placeholder { color: var(--muted); }

/* Filters */
.filters {
  display: flex; gap: 6px;
  padding-bottom: 12px;
  overflow-x: auto; scrollbar-width: none;
}
.filters::-webkit-scrollbar { display: none; }
.filter-btn {
  white-space: nowrap;
  padding: 6px 14px;
  border-radius: 20px;
  border: 1px solid var(--border);
  background: var(--surface2);
  color: var(--text2);
  font-family: var(--body);
  font-size: 12px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.15s;
  flex-shrink: 0;
}
.filter-btn.active {
  background: var(--accent);
  border-color: var(--accent);
  color: white;
}

/* Stats bar */
.stats-bar {
  display: grid; grid-template-columns: repeat(3, 1fr);
  gap: 8px;
  padding: 0 16px 12px;
  flex-shrink: 0;
}
.stat {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 10px;
  padding: 10px 12px;
  text-align: center;
}
.stat-num { font-family: var(--mono); font-size: 18px; font-weight: 600; }
.stat-label { font-size: 10px; color: var(--muted); margin-top: 2px; }
.stat.overdue .stat-num { color: var(--red); }
.stat.wip .stat-num { color: var(--yellow); }
.stat.done .stat-num { color: var(--green); }

/* Task list */
#taskList {
  flex: 1;
  overflow-y: auto;
  padding: 0 16px 80px;
  scrollbar-width: thin;
  scrollbar-color: var(--border) transparent;
}

/* Task card */
.task-card {
  background: var(--surface);
  border: 1px solid var(--border);
  border-radius: 14px;
  padding: 14px;
  margin-bottom: 10px;
  cursor: pointer;
  transition: all 0.15s;
  position: relative;
  overflow: hidden;
}
.task-card::before {
  content: '';
  position: absolute; left: 0; top: 0; bottom: 0;
  width: 3px;
  background: var(--border2);
  border-radius: 3px 0 0 3px;
}
.task-card.prio-crit::before { background: var(--red); }
.task-card.prio-high::before { background: var(--yellow); }
.task-card.prio-med::before  { background: var(--accent); }
.task-card.overdue { background: rgba(247,94,94,0.04); border-color: rgba(247,94,94,0.2); }
.task-card:active { transform: scale(0.98); }

.card-top { display: flex; align-items: flex-start; justify-content: space-between; gap: 8px; margin-bottom: 8px; }
.card-title { font-size: 14px; font-weight: 700; line-height: 1.3; flex: 1; }
.status-badge {
  padding: 3px 9px; border-radius: 8px;
  font-size: 10px; font-weight: 700;
  white-space: nowrap; flex-shrink: 0;
}
.s-new     { background: var(--accent-soft); color: var(--accent); }
.s-wip     { background: var(--yellow-soft); color: var(--yellow); }
.s-done    { background: var(--green-soft);  color: var(--green); }
.s-default { background: var(--surface3);    color: var(--text2); }

.card-meta { display: flex; align-items: center; justify-content: space-between; font-size: 11px; color: var(--muted); }
.card-meta-left { display: flex; align-items: center; gap: 10px; }
.meta-item { display: flex; align-items: center; gap: 4px; }
.prio-tag { font-size: 10px; font-weight: 700; }
.prio-crit-tag { color: var(--red); }
.prio-high-tag { color: var(--yellow); }

/* Empty / loading */
.empty-state {
  text-align: center; padding: 60px 20px;
  color: var(--muted); font-size: 14px;
}
.empty-state .icon { font-size: 40px; margin-bottom: 12px; }
.loading {
  display: flex; align-items: center; justify-content: center;
  padding: 40px; gap: 8px; color: var(--muted); font-size: 13px;
}
.spinner {
  width: 18px; height: 18px;
  border: 2px solid var(--border);
  border-top-color: var(--accent);
  border-radius: 50%;
  animation: spin 0.7s linear infinite;
}
@keyframes spin { to { transform: rotate(360deg); } }

/* FAB */
.fab {
  position: fixed;
  bottom: 24px;
  right: 50%;
  transform: translateX(50%);
  background: var(--accent);
  color: white;
  border: none;
  border-radius: 14px;
  padding: 14px 28px;
  font-family: var(--body);
  font-size: 14px;
  font-weight: 700;
  cursor: pointer;
  box-shadow: 0 4px 24px rgba(79,142,247,0.4);
  display: flex; align-items: center; gap: 8px;
  transition: all 0.2s;
  z-index: 100;
}
.fab:active { transform: translateX(50%) scale(0.97); }

/* ‚îÄ‚îÄ MODAL ‚îÄ‚îÄ */
.modal-overlay {
  position: fixed; inset: 0;
  background: rgba(0,0,0,0.7);
  backdrop-filter: blur(4px);
  z-index: 200;
  display: none; align-items: flex-end;
}
.modal-overlay.open { display: flex; }
.modal {
  background: var(--surface);
  border-radius: 20px 20px 0 0;
  width: 100%; max-width: 480px;
  margin: 0 auto;
  padding: 20px 20px 40px;
  max-height: 90vh;
  overflow-y: auto;
  animation: slideUp 0.25s ease;
}
@keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

.modal-handle {
  width: 36px; height: 4px;
  background: var(--border2);
  border-radius: 2px;
  margin: 0 auto 20px;
}
.modal-title {
  font-family: var(--head);
  font-size: 16px;
  font-weight: 700;
  margin-bottom: 20px;
}

/* Form */
.form-group { margin-bottom: 14px; }
.form-label { font-size: 12px; font-weight: 700; color: var(--text2); margin-bottom: 6px; display: block; letter-spacing: 0.5px; }
.form-input, .form-select, .form-textarea {
  width: 100%;
  background: var(--surface2);
  border: 1px solid var(--border);
  border-radius: 10px;
  padding: 11px 14px;
  color: var(--text);
  font-family: var(--body);
  font-size: 14px;
  outline: none;
  transition: border-color 0.2s;
  appearance: none;
}
.form-input:focus, .form-select:focus, .form-textarea:focus { border-color: var(--accent); }
.form-textarea { resize: none; height: 80px; }
.form-select option { background: var(--surface2); }

.form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }

.btn-save {
  width: 100%;
  background: var(--accent);
  color: white;
  border: none;
  border-radius: 12px;
  padding: 14px;
  font-family: var(--body);
  font-size: 15px;
  font-weight: 700;
  cursor: pointer;
  margin-top: 8px;
  transition: all 0.15s;
}
.btn-save:active { opacity: 0.85; }
.btn-save:disabled { opacity: 0.5; cursor: not-allowed; }

.btn-delete {
  width: 100%;
  background: transparent;
  color: var(--red);
  border: 1px solid rgba(247,94,94,0.3);
  border-radius: 12px;
  padding: 12px;
  font-family: var(--body);
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  margin-top: 8px;
  transition: all 0.15s;
}
.btn-delete:active { background: var(--red-soft); }

/* Toast */
.toast {
  position: fixed;
  top: 20px; left: 50%; transform: translateX(-50%);
  background: var(--surface3);
  border: 1px solid var(--border2);
  border-radius: 10px;
  padding: 10px 18px;
  font-size: 13px;
  font-weight: 600;
  z-index: 500;
  white-space: nowrap;
  opacity: 0;
  transition: opacity 0.2s;
  pointer-events: none;
}
.toast.show { opacity: 1; }
.toast.success { border-color: rgba(45,212,160,0.4); color: var(--green); }
.toast.error   { border-color: rgba(247,94,94,0.4);  color: var(--red); }
</style>
</head>
<body>

<!-- LOGIN -->
<div id="loginScreen">
  <div class="login-logo">üìã</div>
  <div class="login-title">DAO Group<br><span>–ó–∞–¥–∞—á–∏</span></div>
  <p class="login-sub">–í–æ–π–¥–∏—Ç–µ —á–µ—Ä–µ–∑ Microsoft 365<br>—á—Ç–æ–±—ã –≤–∏–¥–µ—Ç—å –∏ —É–ø—Ä–∞–≤–ª—è—Ç—å –∑–∞–¥–∞—á–∞–º–∏</p>
  <button class="btn-login" onclick="login()">
    <span>üîê</span> –í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Microsoft
  </button>
</div>

<!-- APP -->
<div id="appScreen">
  <div class="app-header">
    <div class="header-top">
      <div class="header-title">üìã <span>–ó–∞–¥–∞—á–∏</span></div>
      <div class="header-actions">
        <div class="icon-btn" onclick="loadTasks()" title="–û–±–Ω–æ–≤–∏—Ç—å">üîÑ</div>
        <div class="icon-btn" onclick="logout()" title="–í—ã–π—Ç–∏">üö™</div>
      </div>
    </div>
    <div class="search-wrap">
      <span class="search-icon">üîç</span>
      <input id="searchInput" type="text" placeholder="–ü–æ–∏—Å–∫ –ø–æ —Ç–µ–º–µ..." oninput="renderTasks()">
    </div>
    <div class="filters">
      <button class="filter-btn active" data-filter="–í—Å–µ" onclick="setFilter(this)">–í—Å–µ</button>
      <button class="filter-btn" data-filter="–ù–æ–≤–∞—è" onclick="setFilter(this)">–ù–æ–≤–∞—è</button>
      <button class="filter-btn" data-filter="–í —Ä–∞–±–æ—Ç–µ" onclick="setFilter(this)">–í —Ä–∞–±–æ—Ç–µ</button>
      <button class="filter-btn" data-filter="–í—ã–ø–æ–ª–Ω–µ–Ω–æ" onclick="setFilter(this)">–í—ã–ø–æ–ª–Ω–µ–Ω–æ</button>
    </div>
  </div>

  <div class="stats-bar">
    <div class="stat overdue">
      <div class="stat-num" id="statOverdue">0</div>
      <div class="stat-label">–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ</div>
    </div>
    <div class="stat wip">
      <div class="stat-num" id="statWip">0</div>
      <div class="stat-label">–í —Ä–∞–±–æ—Ç–µ</div>
    </div>
    <div class="stat done">
      <div class="stat-num" id="statDone">0</div>
      <div class="stat-label">–í—ã–ø–æ–ª–Ω–µ–Ω–æ</div>
    </div>
  </div>

  <div id="taskList">
    <div class="loading"><div class="spinner"></div> –ó–∞–≥—Ä—É–∑–∫–∞...</div>
  </div>

  <button class="fab" onclick="openModal()">Ôºã –ù–æ–≤–∞—è –∑–∞–¥–∞—á–∞</button>
</div>

<!-- MODAL -->
<div class="modal-overlay" id="modalOverlay" onclick="closeModalOutside(event)">
  <div class="modal">
    <div class="modal-handle"></div>
    <div class="modal-title" id="modalTitle">–ù–æ–≤–∞—è –∑–∞–¥–∞—á–∞</div>

    <input type="hidden" id="taskId">

    <div class="form-group">
      <label class="form-label">–¢–ï–ú–ê –û–ë–†–ê–©–ï–ù–ò–Ø *</label>
      <input class="form-input" id="fTitle" placeholder="–í–≤–µ–¥–∏—Ç–µ —Ç–µ–º—É...">
    </div>
    <div class="form-group">
      <label class="form-label">–û–ü–ò–°–ê–ù–ò–ï</label>
      <textarea class="form-textarea" id="fDesc" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ –∑–∞–¥–∞—á–∏..."></textarea>
    </div>
    <div class="form-row">
      <div class="form-group">
        <label class="form-label">–°–¢–ê–¢–£–°</label>
        <select class="form-select" id="fStatus">
          <option>–ù–æ–≤–∞—è</option>
          <option>–í —Ä–∞–±–æ—Ç–µ</option>
          <option>–í—ã–ø–æ–ª–Ω–µ–Ω–æ</option>
        </select>
      </div>
      <div class="form-group">
        <label class="form-label">–ü–†–ò–û–†–ò–¢–ï–¢</label>
        <select class="form-select" id="fPriority">
          <option>–ö—Ä–∏—Ç–∏—á–Ω–æ</option>
          <option>–í—ã—Å–æ–∫–∏–π</option>
          <option>–°—Ä–µ–¥–Ω–∏–π</option>
          <option>–ù–∏–∑–∫–∏–π</option>
        </select>
      </div>
    </div>
    <div class="form-row">
      <div class="form-group">
        <label class="form-label">–î–ê–¢–ê –ù–ê–ß–ê–õ–ê</label>
        <input class="form-input" id="fStartDate" type="date">
      </div>
      <div class="form-group">
        <label class="form-label">–î–ê–¢–ê –û–ö–û–ù–ß–ê–ù–ò–Ø</label>
        <input class="form-input" id="fDueDate" type="date">
      </div>
    </div>

    <button class="btn-save" id="btnSave" onclick="saveTask()">üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
    <button class="btn-delete" id="btnDelete" style="display:none" onclick="deleteTask()">üóë –£–¥–∞–ª–∏—Ç—å –∑–∞–¥–∞—á—É</button>
  </div>
</div>

<div class="toast" id="toast"></div>

<script>
// ‚îÄ‚îÄ CONFIG ‚îÄ‚îÄ
const CONFIG = {
  clientId: 'ac5e8b66-d93b-426c-83fc-34d579bc5718',
  tenantId: '98f669c9-3c30-4d33-9690-94a178c68711',
  siteId:   '8e777b43-b4c1-414c-93bf-17171ece7f4d',
  listId:   '6fc6997a-cbbd-48c7-9758-938faa1c34f9',
};

// ‚îÄ‚îÄ MSAL SETUP ‚îÄ‚îÄ
const msalConfig = {
  auth: {
    clientId: CONFIG.clientId,
    authority: `https://login.microsoftonline.com/${CONFIG.tenantId}`,
    redirectUri: 'https://nurankerim3332-cpu.github.io/dao-tasks/',
  },
  cache: { cacheLocation: 'sessionStorage' }
};
const msalInstance = new msal.PublicClientApplication(msalConfig);
const scopes = ['Sites.ReadWrite.All'];

let allTasks = [];
let currentFilter = '–í—Å–µ';

// ‚îÄ‚îÄ AUTH ‚îÄ‚îÄ
async function login() {
  try {
    // initialize() —É–∂–µ –≤—ã–∑–≤–∞–Ω –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã ‚Äî –ø–æ–≤—Ç–æ—Ä–Ω–æ –Ω–µ –Ω—É–∂–µ–Ω
    const result = await msalInstance.loginPopup({ scopes });
    msalInstance.setActiveAccount(result.account);
    showApp();
    loadTasks();
  } catch(e) {
    showToast('–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞: ' + e.message, 'error');
  }
}

async function getToken() {
  const account = msalInstance.getActiveAccount();
  if (!account) throw new Error('–ù–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω');
  const result = await msalInstance.acquireTokenSilent({ scopes, account });
  return result.accessToken;
}

function logout() {
  msalInstance.logoutPopup();
  document.getElementById('appScreen').style.display = 'none';
  document.getElementById('loginScreen').style.display = 'flex';
}

function showApp() {
  document.getElementById('loginScreen').style.display = 'none';
  document.getElementById('appScreen').style.display = 'flex';
}

// ‚îÄ‚îÄ API ‚îÄ‚îÄ
const BASE = `https://graph.microsoft.com/v1.0/sites/${CONFIG.siteId}/lists/${CONFIG.listId}`;

async function apiGet(url) {
  const token = await getToken();
  const r = await fetch(url, { headers: { Authorization: 'Bearer ' + token } });
  if (!r.ok) throw new Error(await r.text());
  return r.json();
}

async function apiPost(url, body) {
  const token = await getToken();
  const r = await fetch(url, {
    method: 'POST',
    headers: { Authorization: 'Bearer ' + token, 'Content-Type': 'application/json' },
    body: JSON.stringify(body)
  });
  if (!r.ok) throw new Error(await r.text());
  return r.json();
}

async function apiPatch(url, body) {
  const token = await getToken();
  const r = await fetch(url, {
    method: 'PATCH',
    headers: { Authorization: 'Bearer ' + token, 'Content-Type': 'application/json' },
    body: JSON.stringify(body)
  });
  if (!r.ok) throw new Error(await r.text());
  return r.status === 204 ? null : r.json();
}

async function apiDelete(url) {
  const token = await getToken();
  const r = await fetch(url, {
    method: 'DELETE',
    headers: { Authorization: 'Bearer ' + token }
  });
  if (!r.ok) throw new Error(await r.text());
}

// ‚îÄ‚îÄ TASKS ‚îÄ‚îÄ
async function loadTasks() {
  document.getElementById('taskList').innerHTML = '<div class="loading"><div class="spinner"></div> –ó–∞–≥—Ä—É–∑–∫–∞...</div>';
  try {
    const url = `${BASE}/items?$expand=fields&$orderby=fields/DueDate asc&$top=200`;
    const data = await apiGet(url);
    allTasks = data.value || [];
    renderTasks();
    updateStats();
  } catch(e) {
    document.getElementById('taskList').innerHTML = `<div class="empty-state"><div class="icon">‚ö†Ô∏è</div>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:<br>${e.message}</div>`;
  }
}

function renderTasks() {
  const search = document.getElementById('searchInput').value.toLowerCase();
  const filtered = allTasks.filter(t => {
    const f = t.fields || {};
    const matchFilter = currentFilter === '–í—Å–µ' || f.Status === currentFilter;
    const matchSearch = !search || (f.Title || '').toLowerCase().includes(search);
    return matchFilter && matchSearch;
  });

  const list = document.getElementById('taskList');
  if (!filtered.length) {
    list.innerHTML = '<div class="empty-state"><div class="icon">üì≠</div>–ó–∞–¥–∞—á –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</div>';
    return;
  }

  list.innerHTML = filtered.map(t => {
    const f = t.fields || {};
    const isOverdue = f.DueDate && new Date(f.DueDate) < new Date() && f.Status !== '–í—ã–ø–æ–ª–Ω–µ–Ω–æ';
    const statusClass = f.Status === '–í—ã–ø–æ–ª–Ω–µ–Ω–æ' ? 's-done' : f.Status === '–í —Ä–∞–±–æ—Ç–µ' ? 's-wip' : 's-new';
    const prioClass = f.Priority === '–ö—Ä–∏—Ç–∏—á–Ω–æ' ? 'prio-crit' : f.Priority === '–í—ã—Å–æ–∫–∏–π' ? 'prio-high' : 'prio-med';
    const prioTagClass = f.Priority === '–ö—Ä–∏—Ç–∏—á–Ω–æ' ? 'prio-crit-tag' : f.Priority === '–í—ã—Å–æ–∫–∏–π' ? 'prio-high-tag' : '';
    const due = f.DueDate ? new Date(f.DueDate).toLocaleDateString('ru-RU', {day:'2-digit', month:'2-digit', hour:'2-digit', minute:'2-digit'}) : '';

    return `<div class="task-card ${prioClass} ${isOverdue ? 'overdue' : ''}" onclick="openModal('${t.id}')">
      <div class="card-top">
        <div class="card-title">${f.Title || '‚Äî'}</div>
        <span class="status-badge ${statusClass}">${f.Status || '–ù–æ–≤–∞—è'}</span>
      </div>
      <div class="card-meta">
        <div class="card-meta-left">
          ${f.Priority ? `<span class="meta-item prio-tag ${prioTagClass}">‚ö° ${f.Priority}</span>` : ''}
          ${due ? `<span class="meta-item">üìÖ ${due}</span>` : ''}
        </div>
        ${isOverdue ? '<span style="color:var(--red);font-size:10px;font-weight:700;">–ü–†–û–°–†–û–ß–ï–ù–û</span>' : ''}
      </div>
    </div>`;
  }).join('');
}

function updateStats() {
  const now = new Date();
  document.getElementById('statOverdue').textContent = allTasks.filter(t => t.fields?.DueDate && new Date(t.fields.DueDate) < now && t.fields?.Status !== '–í—ã–ø–æ–ª–Ω–µ–Ω–æ').length;
  document.getElementById('statWip').textContent = allTasks.filter(t => t.fields?.Status === '–í —Ä–∞–±–æ—Ç–µ').length;
  document.getElementById('statDone').textContent = allTasks.filter(t => t.fields?.Status === '–í—ã–ø–æ–ª–Ω–µ–Ω–æ').length;
}

function setFilter(btn) {
  document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  currentFilter = btn.dataset.filter;
  renderTasks();
}

// ‚îÄ‚îÄ MODAL ‚îÄ‚îÄ
function openModal(taskId) {
  const modal = document.getElementById('modalOverlay');
  modal.classList.add('open');

  if (taskId) {
    const task = allTasks.find(t => t.id === taskId);
    const f = task?.fields || {};
    document.getElementById('modalTitle').textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞–¥–∞—á—É';
    document.getElementById('taskId').value = taskId;
    document.getElementById('fTitle').value = f.Title || '';
    document.getElementById('fDesc').value = f.Description || '';
    document.getElementById('fStatus').value = f.Status || '–ù–æ–≤–∞—è';
    document.getElementById('fPriority').value = f.Priority || '–°—Ä–µ–¥–Ω–∏–π';
    document.getElementById('fStartDate').value = f.EventDate ? f.EventDate.split('T')[0] : '';
    document.getElementById('fDueDate').value = f.DueDate ? f.DueDate.split('T')[0] : '';
    document.getElementById('btnDelete').style.display = 'block';
  } else {
    document.getElementById('modalTitle').textContent = '–ù–æ–≤–∞—è –∑–∞–¥–∞—á–∞';
    document.getElementById('taskId').value = '';
    document.getElementById('fTitle').value = '';
    document.getElementById('fDesc').value = '';
    document.getElementById('fStatus').value = '–ù–æ–≤–∞—è';
    document.getElementById('fPriority').value = '–°—Ä–µ–¥–Ω–∏–π';
    document.getElementById('fStartDate').value = '';
    document.getElementById('fDueDate').value = '';
    document.getElementById('btnDelete').style.display = 'none';
  }
}

function closeModal() {
  document.getElementById('modalOverlay').classList.remove('open');
}

function closeModalOutside(e) {
  if (e.target === document.getElementById('modalOverlay')) closeModal();
}

async function saveTask() {
  const title = document.getElementById('fTitle').value.trim();
  if (!title) { showToast('–í–≤–µ–¥–∏—Ç–µ —Ç–µ–º—É –æ–±—Ä–∞—â–µ–Ω–∏—è', 'error'); return; }

  const btn = document.getElementById('btnSave');
  btn.disabled = true;
  btn.textContent = '–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...';

  const fields = {
    Title: title,
    Description: document.getElementById('fDesc').value,
    Status: document.getElementById('fStatus').value,
    Priority: document.getElementById('fPriority').value,
  };
  const startDate = document.getElementById('fStartDate').value;
  const dueDate = document.getElementById('fDueDate').value;
  if (startDate) fields.EventDate = new Date(startDate).toISOString();
  if (dueDate) fields.DueDate = new Date(dueDate).toISOString();

  const taskId = document.getElementById('taskId').value;

  try {
    if (taskId) {
      await apiPatch(`${BASE}/items/${taskId}/fields`, fields);
      showToast('–ó–∞–¥–∞—á–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞ ‚úì', 'success');
    } else {
      await apiPost(`${BASE}/items`, { fields });
      showToast('–ó–∞–¥–∞—á–∞ —Å–æ–∑–¥–∞–Ω–∞ ‚úì', 'success');
    }
    closeModal();
    loadTasks();
  } catch(e) {
    showToast('–û—à–∏–±–∫–∞: ' + e.message, 'error');
  } finally {
    btn.disabled = false;
    btn.textContent = 'üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
  }
}

async function deleteTask() {
  const taskId = document.getElementById('taskId').value;
  if (!taskId) return;
  if (!confirm('–£–¥–∞–ª–∏—Ç—å –∑–∞–¥–∞—á—É?')) return;

  try {
    await apiDelete(`${BASE}/items/${taskId}`);
    showToast('–ó–∞–¥–∞—á–∞ —É–¥–∞–ª–µ–Ω–∞', 'success');
    closeModal();
    loadTasks();
  } catch(e) {
    showToast('–û—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è', 'error');
  }
}

// ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ
function showToast(msg, type = '') {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.className = 'toast show ' + type;
  setTimeout(() => t.classList.remove('show'), 3000);
}

// ‚îÄ‚îÄ INIT ‚îÄ‚îÄ
(async () => {
  await msalInstance.initialize();
  const accounts = msalInstance.getAllAccounts();
  if (accounts.length) {
    msalInstance.setActiveAccount(accounts[0]);
    showApp();
    loadTasks();
  }
})();
</script>
</body>
</html>
